<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: pixel-change.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: pixel-change.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const bindings = require('./bindings');

const { EventEmitter } = require('events');

/**
 * @fileOverview Utilzes a pixel buffer comparison engine written in c++ for fast calculations.
 * Can be used by creating a new instance with set values and accessing the convenience methods.
 * Can be used statically by directly accessing the public c++ methods.
 * Outputs a percent based on how many pixels are changed between 2 pixel buffers.
 * @requires events.EventEmitter
 * @version v0.0.5
 */
class PixelChange extends EventEmitter {
    /**
     * @constructor
     * @param {Object} options - Configuration options.
     * @param {Number} options.width - Width of image.
     * @param {Number} options.height - Height of image.
     * @param {Number} options.depth - 1 for gray, 3 for rgb, or 4 for rgba.
     * @param {Number} options.difference - Difference level threshold ranging from 1 to 255. Lower number is more sensitive.
     * @param {Number} options.percent - Percent of pixels that meet or exceed difference threshold.
     * @param {Function} [callback] - Function to be called when pixel change is detected.
     * @return {PixelChange}
     */
    constructor(options, callback) {
        super(options);
        if (callback &amp;&amp; typeof callback === 'function' &amp;&amp; callback.length === 2) {
            this._callback = callback;
        }
        if (options &amp;&amp; options.width &amp;&amp; options.height &amp;&amp; options.depth &amp;&amp; options.difference &amp;&amp; options.percent) {

            this._width = parseInt(options.width);
            this._height = parseInt(options.height);
            this._depth = parseInt(options.depth);
            this._difference = parseInt(options.difference);
            this._percent = parseInt(options.percent);

            if (this._width &lt; 1) {
                throw new Error('Invalid width, value must be a positive integer');
            }

            if (this._height &lt; 1) {
                throw new Error('Invalid height, value must be a positive integer');
            }

            if (this._difference &lt; 1 || this._difference > 255) {
                throw new Error('Difference value must be between 1 and 255');
            }

            if (this._percent &lt; 1 || this._percent > 100) {
                throw new Error('Percent value must be between 1 and 100');
            }

            //depth is number of bytes per pixel, gray = 1, rgb = 3, rgba = 4
            switch (this._depth) {
                case 1 :
                    this._pixelChangeEngine = bindings.compareGrayPixels.bind(this, this._width, this._height, this._difference);
                    break;
                case 3 :
                    this._pixelChangeEngine = bindings.compareRgbPixels.bind(this, this._width, this._height, this._difference);
                    break;
                case 4 :
                    this._pixelChangeEngine = bindings.compareRgbaPixels.bind(this, this._width, this._height, this._difference);
                    break;
                default :
                    throw new Error('Invalid depth, value must be 1 for gray, 3 for rgb, or 4 for rgba');
            }

            //byte size of image will be width * height * depth
            this._size = this._width * this._height * this._depth;

        } else {
            throw new Error('Constructor must be called with width, height, depth, difference, and percent');
        }

    }

    /**
     * Get the percentage of different pixels between 2 pixel buffers.
     *
     * @param {Buffer} buf0 - Buffer array of pixels.
     * @param {Buffer} buf1 - Buffer array of pixels.
     * @public
     */
    compare(buf0, buf1) {
        const percent = this._pixelChangeEngine(buf0, buf1);
        /*
        todo
        - will have to make this dispatch an object to accommodate regions of difference.
        - currently will dispatch an event with a single percent because we currently only support whole image
        */
        if (percent >= this._percent) {
            if (this.listenerCount('change') > 0) {
                this.emit('change', percent);
            }
            if (this._callback) {
                this._callback(null, percent);
            }
        }
        return this;
    }

    /**
     * Convenience method to have instance cache previous Buffer and keep feeding to this.compare()
     *
     * @param {Buffer} buf1 - Buffer array of pixels.
     * @public
     */
    push(buf1) {
        if (this._buf0 &amp;&amp; buf1) {
            this.compare(this._buf0, buf1);
        }
        this._buf0 = buf1;
        return this;
    }

    /**
     * Get the percentage of different pixels between 2 grayscale pixel buffers.
     *
     * @param {Number} width - Width of image.
     * @param {Number} height - Height of image.
     * @param {Number} diff - Difference between 2 pixels, 1 - 255.
     * @param {Buffer} buf0 - Buffer array of pixels.
     * @param {Buffer} buf1 - Buffer array of pixels.
     * @returns {Number} - Returns the percentage of pixels that are different.
     * @static
     * @public
     */
    static compareGrayPixels(width, height, diff, buf0, buf1) {
        return bindings.compareGrayPixels(width, height, diff, buf0, buf1);
    }

    /**
     * Get the percentage of different pixels between 2 rgb pixel buffers.
     *
     * @param {Number} width - Width of image.
     * @param {Number} height - Height of image.
     * @param {Number} diff - Difference between 2 pixels, 1 - 255.
     * @param {Buffer} buf0 - Buffer array of pixels.
     * @param {Buffer} buf1 - Buffer array of pixels.
     * @returns {Number} - Returns the percentage of pixels that are different.
     * @static
     * @public
     */
    static compareRgbPixels(width, height, diff, buf0, buf1) {
        return bindings.compareRgbPixels(width, height, diff, buf0, buf1);
    }

    /**
     * Get the percentage of different pixels between 2 rgba pixel buffers.
     *
     * @param {Number} width - Width of image.
     * @param {Number} height - Height of image.
     * @param {Number} diff - Difference between 2 pixels, 1 - 255.
     * @param {Buffer} buf0 - Buffer array of pixels.
     * @param {Buffer} buf1 - Buffer array of pixels.
     * @returns {Number} - Returns the percentage of pixels that are different.
     * @static
     * @public
     */
    static compareRgbaPixels(width, height, diff, buf0, buf1) {
        return bindings.compareRgbaPixels(width, height, diff, buf0, buf1);
    }

    /**
     * Get the region specific percentage of different pixels between 2 rgba pixel buffers.
     *
     * @param {Number} width - Width of image.
     * @param {Number} height - Height of image.
     * @param {Array} regions - Array of regions. [{name: "reg1", difference: 5, count: 76800, bitset: Buffer}]
     * @param {string} regions[i].name - Name of region.
     * @param {Number} regions[i].difference - Difference between 2 pixels, 1 to 255.
     * @param {Number} regions[i].count - Total number of pixels in region.
     * @param {Buffer} regions[i].bitset - Buffer of 1's and 0's to use as bitset for each pixel of image. 0 means that index of pixel is not in region, while 1 indicates that it is. Pixel array is indexed from top left to bottom right.
     * @param {Buffer} buf0 - Buffer array of pixels.
     * @param {Buffer} buf1 - Buffer array of pixels.
     * @returns {Number} - Returns the percentage of pixels that are different.
     * @static
     * @public
     */
    static compareGrayRegions(width, height, regions, buf0, buf1) {
        return bindings.compareGrayRegions(width, height, regions, buf0, buf1);
    }

    static compareRgbRegions(width, height, regions, buf0, buf1) {
        return bindings.compareRgbRegions(width, height, regions, buf0, buf1);
    }

    static compareRgbaRegions(width, height, regions, buf0, buf1) {
        return bindings.compareRgbaRegions(width, height, regions, buf0, buf1);
    }

    static jsCompareGrayPixels(width, height, diff, buf0, buf1) {
        if (!width || !height || !diff || !buf0 || !buf1) {
            throw new Error('Must be 5 args passed as width, height, diff, buffer0, buffer1');
        }
        if (diff &lt; 1 || diff > 255) {
            throw new Error('Difference value must range from 1 to 255');
        }
        const wxh = width * height;
        const len0 = buf0.length;
        const len1 = buf1.length;
        if (len0 !== len1 || len0 !== wxh) {
            throw new Error('Pixels buffers must be the same length and equal to width * height');
        }
        let diffs = 0;
        for (let y = 0, i = 0; y &lt; height; y++) {
            for (let x = 0; x &lt; width; x++, i++) {
                if (Math.abs(buf0[i] - buf1[i]) >= diff) {diffs++;}
            }
        }
        return Math.floor(100 * diffs / wxh);
    }

    static jsCompareRgbPixels(width, height, diff, buf0, buf1) {
        if (!width || !height || !diff || !buf0 || !buf1) {
            throw new Error('Must be 5 args passed as width, height, diff, buffer0, buffer1');
        }
        if (diff &lt; 1 || diff > 255) {
            throw new Error('Difference value must range from 1 to 255');
        }
        const wxh = width * height;
        const len0 = buf0.length;
        const len1 = buf1.length;
        if (len0 !== len1 || len0 !== wxh * 3) {
            throw new Error('Pixels buffers must be the same length and equal to width * height * 3');
        }
        let diffs = 0;
        for (let y = 0, i = 0; y &lt; height; y++) {
            for (let x = 0; x &lt; width; x++, i+=3) {
                if (Math.abs(buf0[i] - buf1[i] + buf0[i+1] - buf1[i+1] + buf0[i+2] - buf1[i+2])/3 >= diff) { diffs++;}
            }
        }
        return Math.floor(100 * diffs / wxh);
    }

    static jsCompareRgbaPixels(width, height, diff, buf0, buf1) {
        if (!width || !height || !diff || !buf0 || !buf1) {
            throw new Error('Must be 5 args passed as width, height, diff, buffer0, buffer1');
        }
        if (diff &lt; 1 || diff > 255) {
            throw new Error('Difference value must range from 1 to 255');
        }
        const wxh = width * height;
        const len0 = buf0.length;
        const len1 = buf1.length;
        if (len0 !== len1 || len0 !== wxh * 4) {
            throw new Error('Pixels buffers must be the same length and equal to width * height * 4');
        }
        let diffs = 0;
        for (let y = 0, i = 0; y &lt; height; y++) {
            for (let x = 0; x &lt; width; x++, i+=4) {
                if (Math.abs(buf0[i] - buf1[i] + buf0[i+1] - buf1[i+1] + buf0[i+2] - buf1[i+2])/3 >= diff) { diffs++;}
            }
        }
        return Math.floor(100 * diffs / wxh);
    }

}

module.exports = PixelChange;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="PixelChange.html">PixelChange</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Feb 03 2018 10:57:30 GMT-0600 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
